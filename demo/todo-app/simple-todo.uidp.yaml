uidp: "0.3.0"

meta:
  name: シンプルToDo
  description: タスクの追加・完了・削除・編集ができるToDoアプリ
  version: "3.0.0"

types:
  Todo:
    id: string
    text: string
    description: string?
    completed: boolean
    createdAt: datetime
    updatedAt: datetime

  TodoForm:
    text: string
    description: string

globals:
  todos:
    type: Todo[]
    initial: []
    persist: localStorage

screens:
  TodoList:
    title: やることリスト
    description: タスクの一覧を表示し、追加・完了・削除ができる

    route: /todos

    state:
      newTodoText:
        type: string
        initial: ""

    computed:
      remainingCount:
        count: todos
        where: not completed

      hasCompleted:
        any: todos
        where: completed

      isEmpty:
        count: todos
        equals: 0

    layout:
      - Card:
          maxWidth: 480px
          margin: auto
          padding: tokens.spacing.lg
          children:
            - Text:
                variant: h1
                content: やることリスト
                align: center

            - Stack:
                direction: horizontal
                gap: tokens.spacing.sm
                children:
                  - TextField:
                      value: newTodoText
                      placeholder: 新しいタスクを入力...
                      flex: 1
                      on:change:
                        set: { newTodoText: value }
                      on:keydown:
                        - when: event.key is Enter and newTodoText is not empty
                          do: actions.addTodo

                  - Button:
                      label: 追加
                      variant: primary
                      disabled: newTodoText is empty
                      on:click: actions.addTodo

            - Spacer:
                height: tokens.spacing.md

            - match: isEmpty
              cases:
                true:
                  - Text:
                      content: タスクがありません
                      color: tokens.colors.text.secondary
                      align: center

                false:
                  - Stack:
                      direction: vertical
                      gap: tokens.spacing.xs
                      children:
                        - each: todos
                          as: todo
                          key: todo.id
                          render:
                            - Stack:
                                direction: horizontal
                                align: center
                                gap: tokens.spacing.sm
                                children:
                                  - Checkbox:
                                      checked: todo.completed
                                      on:change:
                                        bubble: false
                                        action: actions.toggleTodo(todo.id)

                                  - Box:
                                      flex: 1
                                      on:click: navigate(TodoDetail, { id: todo.id })
                                      children:
                                        - Text:
                                            content: todo.text
                                            disabled: todo.completed

                                  - IconButton:
                                      icon: delete
                                      size: small
                                      color: error
                                      on:click:
                                        bubble: false
                                        action: actions.deleteTodo(todo.id)

            - Spacer:
                height: tokens.spacing.md

            - Stack:
                direction: horizontal
                justify: space-between
                align: center
                children:
                  - Text:
                      content: "残り {remainingCount} 件"
                      variant: caption
                      color: tokens.colors.text.secondary

                  - when: hasCompleted
                    show:
                      - Button:
                          label: 完了済みを削除
                          variant: text
                          size: small
                          on:click: actions.clearCompleted

    actions:
      addTodo:
        steps:
          - create: todos
            values:
              id: uuid()
              text: trim(newTodoText)
              description: ""
              completed: false
              createdAt: now
              updatedAt: now
            position: beginning

          - set: { newTodoText: "" }

      toggleTodo:
        params:
          id: string
        steps:
          - update: todos
            find: id equals {id}
            set:
              completed: toggle
              updatedAt: now

      deleteTodo:
        params:
          id: string
        steps:
          - delete: todos
            where: id equals {id}

      clearCompleted:
        steps:
          - delete: todos
            where: completed

  TodoDetail:
    title: タスク詳細
    description: タスクの詳細を表示し、編集できる

    route: /todos/:id

    params:
      id:
        type: string
        required: true

    state:
      form:
        type: form
        schema: TodoForm
        initialFrom: todo
        fields: [text, description]

      isEditing:
        type: boolean
        initial: false

    computed:
      todo:
        find: todos
        where: id equals params.id

      notFound:
        check: todo is null

    layout:
      - Card:
          maxWidth: 480px
          margin: auto
          padding: tokens.spacing.lg
          children:
            - Stack:
                direction: horizontal
                justify: space-between
                align: center
                children:
                  - IconButton:
                      icon: arrow_back
                      on:click: navigate(TodoList)

                  - Text:
                      variant: h2
                      content: タスク詳細

                  - Box:
                      width: 40px

            - Divider

            - Spacer:
                height: tokens.spacing.md

            - when: notFound
              show:
                - Text:
                    content: タスクが見つかりません
                    color: tokens.colors.error
                    align: center

                - Spacer:
                    height: tokens.spacing.md

                - Button:
                    label: 一覧に戻る
                    variant: outlined
                    fullWidth: true
                    on:click: navigate(TodoList)

            - when: not notFound
              show:
                - match: isEditing
                  cases:
                    false:
                      - Stack:
                          direction: vertical
                          gap: tokens.spacing.md
                          children:
                            - Stack:
                                direction: horizontal
                                align: center
                                gap: tokens.spacing.sm
                                children:
                                  - Checkbox:
                                      checked: todo.completed
                                      on:change: actions.toggleComplete

                                  - Text:
                                      variant: h3
                                      content: todo.text
                                      disabled: todo.completed

                            - when: todo.description is not empty
                              show:
                                - Text:
                                    content: todo.description
                                    color: tokens.colors.text.secondary

                            - Divider

                            - Text:
                                content: "作成: {formatDateTime(todo.createdAt, 'YYYY/MM/DD HH:mm')}"
                                variant: caption
                                color: tokens.colors.text.secondary

                            - Text:
                                content: "更新: {formatDateTime(todo.updatedAt, 'YYYY/MM/DD HH:mm')}"
                                variant: caption
                                color: tokens.colors.text.secondary

                            - Spacer:
                                height: tokens.spacing.md

                            - Stack:
                                direction: horizontal
                                gap: tokens.spacing.sm
                                children:
                                  - Button:
                                      label: 編集
                                      variant: primary
                                      flex: 1
                                      on:click: actions.startEdit

                                  - Button:
                                      label: 削除
                                      variant: outlined
                                      color: error
                                      on:click: actions.delete

                    true:
                      - Stack:
                          direction: vertical
                          gap: tokens.spacing.md
                          children:
                            - TextField:
                                label: タイトル
                                value: form.values.text
                                error: form.errors.text
                                on:change:
                                  set: { form.values.text: value }

                            - TextField:
                                label: 詳細（任意）
                                value: form.values.description
                                multiline: true
                                rows: 3
                                on:change:
                                  set: { form.values.description: value }

                            - Stack:
                                direction: horizontal
                                gap: tokens.spacing.sm
                                children:
                                  - Button:
                                      label: 保存
                                      variant: primary
                                      flex: 1
                                      disabled: form.values.text is empty
                                      on:click: actions.save

                                  - Button:
                                      label: キャンセル
                                      variant: outlined
                                      on:click: actions.cancelEdit

    actions:
      toggleComplete:
        steps:
          - update: todos
            find: id equals params.id
            set:
              completed: toggle
              updatedAt: now

      startEdit:
        steps:
          - set: { isEditing: true }
          - set:
              form.values.text: todo.text
              form.values.description: todo.description or ""

      cancelEdit:
        steps:
          - set: { isEditing: false }

      save:
        steps:
          - update: todos
            find: id equals params.id
            set:
              text: trim(form.values.text)
              description: trim(form.values.description)
              updatedAt: now

          - set: { isEditing: false }
          - toast: success("保存しました")

      delete:
        confirm:
          title: タスクの削除
          message: このタスクを削除しますか？
          variant: danger
        steps:
          - delete: todos
            where: id equals params.id

          - navigate: TodoList
          - toast: success("削除しました")


flows:
  TodoFlow:
    initial: TodoList

    transitions:
      - from: TodoList
        to: TodoDetail
        on: selectTodo
        params:
          id: todo.id

      - from: TodoDetail
        to: TodoList
        on: back

      - from: TodoDetail
        to: TodoList
        on: delete
