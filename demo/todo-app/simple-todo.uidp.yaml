uidp: "0.2.1"

meta:
  name: シンプルToDo
  description: タスクの追加・完了・削除・編集ができるToDoアプリ
  version: "2.0.0"

types:
  Todo:
    id: string
    text: string
    description: string?
    completed: boolean
    createdAt: datetime
    updatedAt: datetime

  TodoForm:
    text: string
    description: string

globals:
  todos:
    type: Todo[]
    initial: []
    persist: localStorage

screens:
  TodoList:
    title: やることリスト
    description: タスクの一覧を表示し、追加・完了・削除ができる

    route: /todos

    state:
      newTodoText:
        type: string
        initial: ""

    computed:
      remainingCount:
        type: number
        expr: $globals.todos.filter(t => !t.completed).length

      hasCompleted:
        type: boolean
        expr: $globals.todos.some(t => t.completed)

      isEmpty:
        type: boolean
        expr: $globals.todos.length == 0

    layout:
      - Card:
          maxWidth: 480px
          margin: auto
          padding: $tokens.spacing.lg
          children:
            - Text:
                variant: h1
                content: やることリスト
                align: center

            - Stack:
                direction: horizontal
                gap: $tokens.spacing.sm
                children:
                  - TextField:
                      value: $newTodoText
                      placeholder: 新しいタスクを入力...
                      flex: 1
                      on:change:
                        set: { newTodoText: $value }
                      on:keydown:
                        - when: $event.key == "Enter" && $newTodoText.trim() != ""
                          then: actions.addTodo

                  - Button:
                      label: 追加
                      variant: primary
                      disabled: $newTodoText.trim() == ""
                      on:click: actions.addTodo

            - Spacer:
                height: $tokens.spacing.md

            - switch:
                value: $isEmpty
                cases:
                  - case: true
                    then:
                      - Text:
                          content: タスクがありません
                          color: $tokens.colors.text.secondary
                          align: center

                  - case: false
                    then:
                      - Stack:
                          direction: vertical
                          gap: $tokens.spacing.xs
                          children:
                            - each: $globals.todos
                              as: todo
                              key: $todo.id
                              render:
                                - Stack:
                                    direction: horizontal
                                    align: center
                                    gap: $tokens.spacing.sm
                                    children:
                                      - Checkbox:
                                          checked: $todo.completed
                                          on:change:
                                            stop: true
                                            action: actions.toggleTodo($todo.id)

                                      - Box:
                                          flex: 1
                                          on:click: navigate(TodoDetail, { id: $todo.id })
                                          children:
                                            - Text:
                                                content: $todo.text
                                                disabled: $todo.completed

                                      - IconButton:
                                          icon: delete
                                          size: small
                                          color: error
                                          on:click:
                                            stop: true
                                            action: actions.deleteTodo($todo.id)

            - Spacer:
                height: $tokens.spacing.md

            - Stack:
                direction: horizontal
                justify: space-between
                align: center
                children:
                  - Text:
                      content: "残り ${$remainingCount} 件"
                      variant: caption
                      color: $tokens.colors.text.secondary

                  - when: $hasCompleted
                    then:
                      - Button:
                          label: 完了済みを削除
                          variant: text
                          size: small
                          on:click: actions.clearCompleted

    actions:
      addTodo:
        steps:
          - set:
              globals.todos:
                - id: uuid()
                  text: $newTodoText.trim()
                  description: ""
                  completed: false
                  createdAt: now()
                  updatedAt: now()
                - ...$globals.todos
          - set: { newTodoText: "" }

      toggleTodo:
        params:
          id: string
        steps:
          - set:
              globals.todos: $globals.todos.map(t =>
                t.id == $id
                  ? { ...t, completed: !t.completed, updatedAt: now() }
                  : t
              )

      deleteTodo:
        params:
          id: string
        steps:
          - set:
              globals.todos: $globals.todos.filter(t => t.id != $id)

      clearCompleted:
        steps:
          - set:
              globals.todos: $globals.todos.filter(t => !t.completed)

  TodoDetail:
    title: タスク詳細
    description: タスクの詳細を表示し、編集できる

    route: /todos/:id

    params:
      id:
        type: string
        required: true

    state:
      form:
        type: form<TodoForm>
        initialFrom: $todo
        fields: [text, description]

      isEditing:
        type: boolean
        initial: false

    computed:
      todo:
        type: Todo?
        expr: $globals.todos.find(t => t.id == $params.id)

      notFound:
        type: boolean
        expr: $todo == null

    layout:
      - Card:
          maxWidth: 480px
          margin: auto
          padding: $tokens.spacing.lg
          children:
            - Stack:
                direction: horizontal
                justify: space-between
                align: center
                children:
                  - IconButton:
                      icon: arrow_back
                      on:click: navigate(TodoList)

                  - Text:
                      variant: h2
                      content: タスク詳細

                  - Box:
                      width: 40px

            - Divider

            - Spacer:
                height: $tokens.spacing.md

            - switch:
                value: $notFound
                cases:
                  - case: true
                    then:
                      - Text:
                          content: タスクが見つかりません
                          color: $tokens.colors.error
                          align: center

                      - Spacer:
                          height: $tokens.spacing.md

                      - Button:
                          label: 一覧に戻る
                          variant: outlined
                          fullWidth: true
                          on:click: navigate(TodoList)

                  - case: false
                    then:
                      - switch:
                          value: $isEditing
                          cases:
                            - case: false
                              then:
                                - Stack:
                                    direction: vertical
                                    gap: $tokens.spacing.md
                                    children:
                                      - Stack:
                                          direction: horizontal
                                          align: center
                                          gap: $tokens.spacing.sm
                                          children:
                                            - Checkbox:
                                                checked: $todo.completed
                                                on:change: actions.toggleComplete

                                            - Text:
                                                variant: h3
                                                content: $todo.text
                                                disabled: $todo.completed

                                      - when: $todo.description
                                        then:
                                          - Text:
                                              content: $todo.description
                                              color: $tokens.colors.text.secondary

                                      - Divider

                                      - Text:
                                          content: "作成: ${formatDateTime($todo.createdAt, 'YYYY/MM/DD HH:mm')}"
                                          variant: caption
                                          color: $tokens.colors.text.secondary

                                      - Text:
                                          content: "更新: ${formatDateTime($todo.updatedAt, 'YYYY/MM/DD HH:mm')}"
                                          variant: caption
                                          color: $tokens.colors.text.secondary

                                      - Spacer:
                                          height: $tokens.spacing.md

                                      - Stack:
                                          direction: horizontal
                                          gap: $tokens.spacing.sm
                                          children:
                                            - Button:
                                                label: 編集
                                                variant: primary
                                                flex: 1
                                                on:click: actions.startEdit

                                            - Button:
                                                label: 削除
                                                variant: outlined
                                                color: error
                                                on:click: actions.delete

                            - case: true
                              then:
                                - Stack:
                                    direction: vertical
                                    gap: $tokens.spacing.md
                                    children:
                                      - TextField:
                                          label: タイトル
                                          value: $form.values.text
                                          error: $form.errors.text
                                          on:change:
                                            set: { form.values.text: $value }

                                      - TextField:
                                          label: 詳細（任意）
                                          value: $form.values.description
                                          multiline: true
                                          rows: 3
                                          on:change:
                                            set: { form.values.description: $value }

                                      - Stack:
                                          direction: horizontal
                                          gap: $tokens.spacing.sm
                                          children:
                                            - Button:
                                                label: 保存
                                                variant: primary
                                                flex: 1
                                                disabled: $form.values.text.trim() == ""
                                                on:click: actions.save

                                            - Button:
                                                label: キャンセル
                                                variant: outlined
                                                on:click: actions.cancelEdit

    actions:
      toggleComplete:
        steps:
          - set:
              globals.todos: $globals.todos.map(t =>
                t.id == $params.id
                  ? { ...t, completed: !t.completed, updatedAt: now() }
                  : t
              )

      startEdit:
        steps:
          - set: { isEditing: true }
          - set:
              form.values:
                text: $todo.text
                description: $todo.description ?? ""

      cancelEdit:
        steps:
          - set: { isEditing: false }

      save:
        steps:
          - set:
              globals.todos: $globals.todos.map(t =>
                t.id == $params.id
                  ? {
                      ...t,
                      text: $form.values.text.trim(),
                      description: $form.values.description.trim(),
                      updatedAt: now()
                    }
                  : t
              )
          - set: { isEditing: false }
          - toast: success("保存しました")

      delete:
        confirm:
          title: タスクの削除
          message: このタスクを削除しますか？
          variant: danger
        steps:
          - set:
              globals.todos: $globals.todos.filter(t => t.id != $params.id)
          - navigate: TodoList
          - toast: success("削除しました")

flows:
  TodoFlow:
    initial: TodoList

    transitions:
      - from: TodoList
        to: TodoDetail
        on: selectTodo
        params:
          id: $todo.id

      - from: TodoDetail
        to: TodoList
        on: back

      - from: TodoDetail
        to: TodoList
        on: delete
